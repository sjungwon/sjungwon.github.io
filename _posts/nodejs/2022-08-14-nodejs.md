---
layout: post
title: Nodejs
date: 2022-08-14 21:02 +0900
categories: ["노드"]
---

노드는 자바스크립트를 언어로 사용한다면 클라이언트, 서버 어디서든 사용 된다. 먼저 Node가 무엇인지 작성해보면 좋을 것 같아 공식 문서를 보며 작성해보려 한다.

[공식문서](https://nodejs.org/ko/about/)

## Nodejs란

- 비동기 이벤트 주도 자바스크립트 런타임

  - 비동기: 일정 단위 코드의 실행을 메인 흐름에서 기다리지 않는 것을 보통 비동기라고 표현
    - 예를 들어 어떤 변수 a에 단순한 값이 아닌 계산된 값을 할당하는 경우,
    - 동기로 a에 계산된 값을 할당하면 할당 이후의 모든 코드에서 a에 접근하면 계산된 값을 얻을 수 있다.
    - 반면에 비동기로 a에 계산된 값을 할당한다면 값의 계산은 메인 흐름에서 벗어나 계산되고 이후의 모든 코드에서 계산된 값을 얻을 수 있다는 것을 보장할 수 없다.
  - ```javascript
    //동기 코드
    let a = 0;
    a = 3 + 1;
    const b = a;
    const c = a;
    console.log(a, b, c);

    //비동기 코드
    const exam = () => {
      let a = 0;
      setTimeout(() => {
        a = 3 + 1;
        console.log(a, b, c);
      }, 3000);
      const b = a;
      const c = a;
      console.log(a, b, c);
    };

    exam();

    //결과
    //4,4,4
    //0,0,0
    //4,0,0
    ```

  - 이벤트 주도: 이벤트 발생에 따라 어떤 로직을 처리함
    - Event-Driven-Architecture
    - 다른 블로그에 잘 설명되어 있어 링크함
    - [좋은 설명 링크](https://jaehun2841.github.io/2019/06/23/2019-06-23-event-driven-architecture/#EDA-Event-driven-architecture-%EC%9D%98-%EA%B5%AC%EC%84%B1%EC%9A%94%EC%86%8C)

- OS 스레드가 일반적으로 사용하는 동시성 모델과는 대조적입니다. 스레드 기반의 네트워크는 상대적으로 비효율적이고 사용하기가 몹시 어렵습니다. 게다가 잠금이 없으므로 Node.js 의 사용자는 프로세스의 교착상태에 대해서 걱정할 필요가 없습니다.

  - 프로세스는 프로그램이 실행된 인스턴스라고 생각하면 된다. 프로세스는 OS에서 자원을 할당받는 작업의 단위이다.
  - 각 프로세스는 독립적인 시스템 자원을 할당받는다.
  - 할당받는 시스템 자원은 CPU 시간, 실행에 필요한 주소 공간, 메모리 등이 있다.
  - 스레드는 프로세스내에서 실행되는 여러 흐름의 단위이다. 여러 스레드는 프로세스가 할당받은 OS 자원을 공유해서 사용한다.
  - 동시성이란 동시에 실행되는 것처럼 보이는 것이다.
  - 스레드 동시성은 여러 스레드가 동시에 실행되는 것 처럼 보이며 공유하는 자원 중에 동일한 자원을 놓고 경쟁할 수 있다. -> 서로 사용하려함
  - 보통 이런 경우 두 스레드가 동일한 자원에 접근하려면 정해둔 규칙에 따라 사용하게 되는 스레드 쪽에서 락을 걸어 다른 스레드가 접근할 수 없게 막아둔다.
  - 잠금이 없다는 것은 여러 스레드가 동시에 동일한 자원에 접근할 일이 없어 락을 걸지 않아도 된다는 것이다.
  - 교착 상태란 두 스레드가 A,B라는 자원이 필요한 경우 한 스레드는 A 자원에 락을 걸고 다른 스레드는 B 자원에 락을 걸고 서로의 자원이 락이 해제되기를 무한히 기다리게 되는 상태를 말한다.
  - 락이 없기 때문에 교착 상태를 고려하지 않아도 된다는 뜻이다.

- Node.js 에서 I/O를 직접 수행하는 함수는 거의 없으므로 프로세스는 결과 블로킹 되지 않습니다. 아무것도 블로킹 되지 않으므로 Node.js 에서는 확장성 있는 시스템을 개발하는 게 아주 자연스럽습니다.

  - I/O를 직접 수행하지 않는다 -> 비동기로 던져놓는다고 해석
  - 블로킹 되지 않는다 -> I/O의 결과가 오면 처리할 뿐 처리를 대기하지 않는다.

- 첫줄의 비동기 이벤트 주도를 아래의 공식 문서의 예제 코드로 이해해보면

  - 요청이 올 때까지가 Nodejs는 대기
  - 요청이 오면 이벤트 발생
  - 이벤트에 따른 로직 처리
  - I/O 작업이 필요하다면 비동기로 처리
  - 그 사이 다른 요청이 오면 해당 요청 처리
  - 비동기 끝나면 응답 전송

- 노드는 이벤트 루프를 라이브러리가 아닌 런타임 생성자로 제공
  - 다른 시스템과 달리 이벤트 루프를 시작하는 블럭킹 호출이 없음
  - 노드는 입력 스크립트를 실행한 후 이벤트 루프에 바로 진입함.
  - 더 이상 실행할 콜백이 없다면 노드는 이벤트 루프를 종료함
- 노드는 HTTP를 일급 객체로 다룸.
- 노드는 스레드를 사용하지 않도록 설계되었지만 멀티 코어의 장점을 얻지 못한다는 것은 아님
  - child_process.fork()를 사용해 자식 프로세스를 생성할 수 있음

### 사담

- 스레드 동시성 모델으로 동작하는 서버로 자바 + 스프링이 있는 것으로 알고 있다.
- 두 조합을 사용해보지 않아서 추상적으로 비동기 + 이벤트 주도가 I/O 블럭킹이 없고 스레드를 직접 다루지 않아도 되서 락과 교착상태에 대한 걱정이 없다는 장점을 이론적으로만 이해할 수 있었다.
- 자프링을 공부해보고 비교할 기회가 있다면 좋을 것 같다.
- 블로킹대 논 블로킹을 읽어보고 여러 블로그의 글도 읽어본 결과 요청에 대한 처리에 I/O 접근이 많고, CPU 연산이 많이 필요하지 않다면 단일 스레드로 자바스크립트를 실행하고 I/O를 비동기로 던지는 노드를 선택하는 것이 좋고, CPU 연산이 꽤 필요하다면 자바 + 스프링 같은 멀티스레드 프레임워크로 스레드를 나눠서 처리하는 쪽을 선택하는 것이 좋을 것 같다.
- 추가적으로 스프링을 잠깐 공부해보고 알게된 내용인데 스프링은 웹서버인 톰캣을 내장해서 요청과 응답을 처리한다면 노드는 자체적으로 웹서버 역할을 수행할 수 있다. 따라서 노드는 어떻게 보면 자바스크립트 런타임이자 웹서버인 느낌이다.

#### 참고 자료

[[Java] 멀티 스레드환경의 동시성 이슈 그리고 해결방법](https://velog.io/@mooh2jj/%EB%A9%80%ED%8B%B0-%EC%8A%A4%EB%A0%88%EB%93%9C%EC%9D%98-%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%9D%B4%EC%8A%88)  
[[OS] 스레드와 동시성(Thread & Concurrency)](https://dkswnkk.tistory.com/401?category=513905) - 자세함

### 추가 스프링과 비교
