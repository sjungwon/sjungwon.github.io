---
layout: post
title: 블로킹 vs 논-블로킹
date: 2022-08-14 23:39 +0900
categories: ["노드"]
---

- I/O는 주로 libuv가 지원하는 시스템 디스크나 네트워크와 상호작용하는 것을 가리킨다.

  - [libuv](https://libuv.org/)

  - 위 링크를 타고 libuv로 들어가면 Asyncronous I/O made simple - libuv is a multi-platform support library with a focus on asynchronous I/O라는 첫 글이 나온다.
  - Node는 I/O를 직접 수행하는 함수가 거의 없다는 것이 libuv를 사용함으로써 비동기로 처리한다는 것을 알 수 있다.
  - libuv에 대한 포스트 : [libuv 포스트](https://sjungwon.github.io/posts/libuv)

### 블로킹

- 블로킹은 노드 프로세스가 추가적인 자바스크립트 실행을 위해 자바스크립트가 아닌 작업이 안료될 때까지 기대려야하는 상황을 뜻한다.
- 이는 이벤트 루프가 블로킹 작업을 하는 동안 자바스크립트 실행을 계속할 수 없기 때문
- 동기적인 코드 수행이라고 생각하면 될 것 같다.
- 단일 흐름(스레드)으로 실행된다면 I/O의 응답을 기다리는 동안 다른 작업을 못 하기 때문에 대기해야한다.
- 노드에서는 많은 연산을 해야하는 CPU 집약적인 자바스크립트 코드 실행을 블로킹이라 부르지 않고 I/O와 같은 자바스크립트가 아닌 작업을 기다리는 것을 블로킹이라 부름.
- libuv를 사용하는 노드 표준 라이브러리의 동기 메서드가 대표적인 블로킹 작업이며 네이티브 모듈도 블로킹 메서드를 가질 수 있음
- 노드의 표준 라이브러리의 모든 I/O 메서드는 논블로킹인 비동기 방식을 제공하고 콜백 함수를 받는다. 일부 메서드는 블로킹 메서드도 가지며 마지막에 sync 키워드가 붙는다.
  > 요약: 자바스크립트 코드는 CPU 집약적인(연산이 많은) 코드이더라도 블로킹이라 부르지 않으며 I/O와 같이 자바스크립트가 아닌 수행을 기다리는 것을 블로킹이라 부름. 표준 라이브러리의 I/O 메서드는 비동기이며 동기 방식을 제공하는 경우도 있음

### 코드 비교

아래 코드는 공식 문서의 예시임  
동기:

```javascript
const fs = require("fs");
const data = fs.readFileSync("/file.md"); // 파일을 읽을 때까지 여기서 블로킹됩니다.
console.log(data);
moreWork(); // console.log 이후 실행될 것입니다.
```

비동기:

```javascript
const fs = require("fs");
fs.readFile("/file.md", (err, data) => {
  if (err) throw err;
  console.log(data);
});
moreWork(); // console.log 이전에 실행될 것입니다.
```

동기의 경우 파일 작업을 대기하고 이후에 console, moreWork가 실행됨
비동기의 경우 파일 작업을 요청해놓고 이후 자바스크립트 코드를 실행 - moreWork가 console보다 먼저 실행됨

### 동시성과 스루풋

- 노드에서 자바스크립트 실행이 싱글스레드 - 노드 전체가 싱글 스레드가 아님
- 동시성은 다른 작업이 완료된 후 자바스크립트 콜백 함수를 실행하는 이벤트 루프의 능력을 의미
- I/O 작업과 같이 동시에 실행돼야 한다고 예상되는 자바스크립트가 아닌 코드들은 이벤트 루프가 계속 실행될 수 있도록 보장해야한다. - 간단하게는 자바스크립트가 아니라면 자바스크립트 작업을 막아서는 안된다.
- 예를 들어 각 요청 완료까지 50ms가 걸리고 45ms는 비동기 DB I/O인 상황이라면 논 블로킹으로 작업하면 5초의 자바스크립트 작업 후 45ms는 다른 요청을 처리할 수 있다.
- 이벤트 루프는 동시 작업을 다루려고 부가적인 스레드를 만드는 다른 언어의 모델과는 다르다. 각 스레드가 요청을 처리하지 않고 단일 스레드가 요청을 확인하고 동작을 수행하는 대신 자바스크립트가 아닌 동작을 비동기로 처리 - libuv로 비동기 처리 - 네트워크는 커널에 비동기로 요청, 파일은 다른 스레드에서 작업함
